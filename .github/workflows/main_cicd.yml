name: CI/CD Laravel a Azure App Service

on:
  push:
    branches:
      - main # Ejecuta el pipeline cada vez que haya un push a la rama principal.

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production # Entorno de producción para trazabilidad (opcional)

    steps:
    - uses: actions/checkout@v4
    
    # 1. Configurar PHP y dependencias (Laravel requiere PHP 8.x)
    - name: Set up PHP 8.2
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Versión PHP de tu App Service (según Despliegue DevOps)
        extensions: mbstring, pdo_mysql, zip # Extensiones comunes de Laravel
        coverage: none
    
    - name: Instalar dependencias de Composer
      run: composer install --no-dev --prefer-dist
      
    # 2. Despliegue al App Service usando el Secreto
    - name: 'Deploy to Azure Web App: oswaldo-eduhub-2025'
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'oswaldo-eduhub-2025' # Tu App Service
        slot-name: 'Production'
        # Usa el secreto que acabas de crear
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }} 
        package: .
